{% set is_splitted = index is defined and length is defined %}
{% for message in messages %}
    {% set content = message['content'] + '<|im_end|>\n' %}
    {% if message['role'] != 'assistant' or not is_splitted %}
        {% set content = '<|im_start|>' + message['role'] + '\n' + content %}
    {% endif %}
    {{- content -}}
{% endfor %}
{% if add_generation_prompt %}
    {{- '<|im_start|>assistant\n' -}}
{% endif %}
